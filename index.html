<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced XP Counter</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 900px;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        h2 {
            color: #444;
            margin: 15px 0;
        }
        
        h3 {
            color: #555;
            margin: 10px 0;
        }
        
        .screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        input, button, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        
        input, select {
            background-color: #f9f9f9;
        }
        
        button {
            background: linear-gradient(to right, #4776E6, #8E54E9);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .profile-list {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .profile-item {
            background: linear-gradient(to right, #f5f7fa, #c3cfe2);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .profile-info {
            text-align: left;
            flex: 1;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 18px;
        }
        
        .profile-xp {
            color: #4776E6;
            font-size: 16px;
        }
        
        .profile-level {
            color: #8E54E9;
            font-size: 14px;
        }
        
        .profile-actions {
            display: flex;
            gap: 5px;
        }
        
        .profile-actions button {
            width: auto;
            margin-left: 5px;
            padding: 8px 12px;
        }
        
        .xp-display {
            font-size: 24px;
            font-weight: bold;
            color: #4776E6;
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f5ff;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .level-display {
            font-size: 20px;
            font-weight: bold;
            color: #8E54E9;
            margin: 15px 0;
            padding: 12px;
            background-color: #f7f0ff;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 20px;
            background: linear-gradient(to right, #4776E6, #8E54E9);
            border-radius: 10px;
            text-align: center;
            line-height: 20px;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease-in-out;
        }
        
        .xp-input {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .xp-input input {
            flex: 1;
        }
        
        .xp-input button {
            width: 100px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #4CAF50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .show {
            opacity: 1;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4776E6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nav {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .nav button {
            width: auto;
            padding: 10px 20px;
        }
        
        .logout-btn {
            background: linear-gradient(to right, #FF512F, #DD2476);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(to right, #f5f7fa, #c3cfe2);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4776E6;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .achievement {
            background: linear-gradient(to right, #f5f7fa, #c3cfe2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .achievement i {
            font-size: 30px;
            color: #8E54E9;
            margin-bottom: 10px;
        }
        
        .achievement.locked {
            opacity: 0.5;
        }
        
        .achievement-name {
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .achievement-desc {
            font-size: 10px;
            color: #666;
        }
        
        .chart-container {
            margin: 20px 0;
            position: relative;
            height: 300px;
        }
        
        .tab-container {
            display: flex;
            margin: 20px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid #4776E6;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .history-date {
            color: #666;
            font-size: 14px;
        }
        
        .history-xp {
            color: #4776E6;
            font-weight: bold;
        }
        
        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-label {
            font-weight: bold;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4776E6;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .export-options button {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .achievements-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
            
            .nav {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-star"></i> Advanced XP Counter</h1>
        
        <!-- Main Menu Screen -->
        <div id="mainMenu" class="screen active">
            <button id="createProfileBtn"><i class="fas fa-plus"></i> Create New Profile</button>
            <button id="manageProfilesBtn"><i class="fas fa-users-cog"></i> Manage Profiles</button>
            <h3>Your Profiles</h3>
            <div class="profile-list" id="mainMenuProfiles"></div>
        </div>
        
        <!-- Create Profile Screen -->
        <div id="createProfile" class="screen">
            <h2><i class="fas fa-user-plus"></i> Create New Profile</h2>
            <input type="text" id="profileName" placeholder="Enter profile name">
            <input type="password" id="profilePin" placeholder="Create a 4-digit PIN" maxlength="4">
            <select id="levelSystem">
                <option value="linear">Linear Level System (500 XP per level)</option>
                <option value="exponential">Exponential Level System (increasing XP needed)</option>
                <option value="custom">Custom Level System</option>
            </select>
            <button id="createProfileConfirm">Create Profile</button>
            <button class="backBtn">Back</button>
        </div>
        
        <!-- Login Screen -->
        <div id="login" class="screen">
            <h2><i class="fas fa-sign-in-alt"></i> Select Profile</h2>
            <div class="profile-list" id="profileList"></div>
            <button class="backBtn">Back</button>
        </div>
        
        <!-- PIN Entry Screen -->
        <div id="pinEntry" class="screen">
            <h2><i class="fas fa-lock"></i> Enter PIN</h2>
            <input type="password" id="pinInput" placeholder="Enter your 4-digit PIN" maxlength="4">
            <button id="pinSubmit">Submit</button>
            <button class="backBtn">Back</button>
        </div>
        
        <!-- XP Counter Screen -->
        <div id="xpCounter" class="screen">
            <h2 id="currentProfileName">Profile Name</h2>
            
            <div class="tab-container">
                <div class="tab active" data-tab="dashboard">Dashboard</div>
                <div class="tab" data-tab="stats">Statistics</div>
                <div class="tab" data-tab="achievements">Achievements</div>
                <div class="tab" data-tab="history">History</div>
                <div class="tab" data-tab="settings">Settings</div>
            </div>
            
            <div class="tab-content active" id="dashboard">
                <div class="level-display">
                    Level: <span id="levelAmount">1</span>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar" id="levelProgress">0%</div>
                </div>
                
                <div class="xp-display">
                    XP: <span id="xpAmount">0</span> / <span id="nextLevelXp">500</span>
                </div>
                
                <div class="xp-input">
                    <input type="number" id="xpInput" placeholder="Enter XP to add">
                    <select id="xpCategory">
                        <option value="general">General</option>
                        <option value="quests">Quests</option>
                        <option value="skills">Skills</option>
                        <option value="achievements">Achievements</option>
                    </select>
                    <button id="addXp">Add XP</button>
                </div>
                
                <button id="resetXp">Reset XP</button>
            </div>
            
            <div class="tab-content" id="stats">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalXpGained">0</div>
                        <div class="stat-label">Total XP Gained</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="daysActive">1</div>
                        <div class="stat-label">Days Active</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgXpPerDay">0</div>
                        <div class="stat-label">Avg XP Per Day</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="achievementsEarned">0</div>
                        <div class="stat-label">Achievements</div>
                    </div>
                </div>
                
                <h3>XP Distribution</h3>
                <div class="chart-container">
                    <canvas id="xpDistributionChart"></canvas>
                </div>
                
                <h3>XP History</h3>
                <div class="chart-container">
                    <canvas id="xpHistoryChart"></canvas>
                </div>
            </div>
            
            <div class="tab-content" id="achievements">
                <h3>Your Achievements</h3>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>
            
            <div class="tab-content" id="history">
                <h3>XP History</h3>
                <div class="history-list" id="xpHistoryList"></div>
            </div>
            
            <div class="tab-content" id="settings">
                <h3>Profile Settings</h3>
                
                <div class="settings-option">
                    <div class="settings-label">Enable Notifications</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notificationsToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="settings-option">
                    <div class="settings-label">Show XP Animation</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="animationToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="settings-option">
                    <div class="settings-label">Dark Mode</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <h3>Data Management</h3>
                <div class="export-options">
                    <button id="exportData"><i class="fas fa-download"></i> Export Data</button>
                    <button id="importData"><i class="fas fa-upload"></i> Import Data</button>
                </div>
                
                <button id="changePin">Change PIN</button>
                <button id="deleteProfile" class="logout-btn">Delete Profile</button>
            </div>
            
            <div class="nav">
                <button class="backBtn">Back to Profile</button>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
        </div>
        
        <!-- Manage Profiles Screen -->
        <div id="manageProfiles" class="screen">
            <h2><i class="fas fa-users-cog"></i> Manage Profiles</h2>
            <div class="profile-list" id="manageProfileList"></div>
            <button class="backBtn">Back</button>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <input type="file" id="importFile" style="display: none;" accept=".json">

    <script>
        // Main application code with enhanced features
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const screens = document.querySelectorAll('.screen');
            const mainMenu = document.getElementById('mainMenu');
            const createProfileScreen = document.getElementById('createProfile');
            const loginScreen = document.getElementById('login');
            const pinEntryScreen = document.getElementById('pinEntry');
            const xpCounterScreen = document.getElementById('xpCounter');
            const manageProfilesScreen = document.getElementById('manageProfiles');
            
            const mainMenuProfiles = document.getElementById('mainMenuProfiles');
            const profileList = document.getElementById('profileList');
            const manageProfileList = document.getElementById('manageProfileList');
            
            const profileNameInput = document.getElementById('profileName');
            const profilePinInput = document.getElementById('profilePin');
            const pinInput = document.getElementById('pinInput');
            const xpInput = document.getElementById('xpInput');
            const levelSystemSelect = document.getElementById('levelSystem');
            
            const currentProfileName = document.getElementById('currentProfileName');
            const xpAmount = document.getElementById('xpAmount');
            const levelAmount = document.getElementById('levelAmount');
            const nextLevelXp = document.getElementById('nextLevelXp');
            const levelProgress = document.getElementById('levelProgress');
            
            const totalXpGained = document.getElementById('totalXpGained');
            const daysActive = document.getElementById('daysActive');
            const avgXpPerDay = document.getElementById('avgXpPerDay');
            const achievementsEarned = document.getElementById('achievementsEarned');
            
            const achievementsGrid = document.getElementById('achievementsGrid');
            const xpHistoryList = document.getElementById('xpHistoryList');
            
            const notification = document.getElementById('notification');
            const importFile = document.getElementById('importFile');
            
            // State variables
            let profiles = JSON.parse(localStorage.getItem('xpProfiles')) || [];
            let currentProfile = null;
            let xpDistributionChart = null;
            let xpHistoryChart = null;
            
            // Level systems
            const levelSystems = {
                linear: {
                    name: "Linear",
                    calculateLevel: (xp) => Math.floor(xp / 500) + 1,
                    xpForLevel: (level) => (level - 1) * 500,
                    xpForNextLevel: (xp, level) => level * 500
                },
                exponential: {
                    name: "Exponential",
                    calculateLevel: (xp) => {
                        let level = 1;
                        let xpNeeded = 500;
                        while (xp >= xpNeeded) {
                            level++;
                            xp -= xpNeeded;
                            xpNeeded = Math.floor(xpNeeded * 1.5);
                        }
                        return level;
                    },
                    xpForLevel: (level) => {
                        let totalXp = 0;
                        let xpNeeded = 500;
                        for (let i = 1; i < level; i++) {
                            totalXp += xpNeeded;
                            xpNeeded = Math.floor(xpNeeded * 1.5);
                        }
                        return totalXp;
                    },
                    xpForNextLevel: (xp, level) => {
                        let xpNeeded = 500;
                        for (let i = 1; i < level; i++) {
                            xpNeeded = Math.floor(xpNeeded * 1.5);
                        }
                        return xpNeeded;
                    }
                }
            };
            
            // Achievements
            const achievements = [
                { id: 'first_xp', name: 'First Steps', description: 'Earn your first XP', icon: 'fa-star', condition: (p) => p.xp > 0 },
                { id: 'level_5', name: 'Apprentice', description: 'Reach level 5', icon: 'fa-graduation-cap', condition: (p) => p.level >= 5 },
                { id: 'level_10', name: 'Journeyman', description: 'Reach level 10', icon: 'fa-medal', condition: (p) => p.level >= 10 },
                { id: 'level_20', name: 'Master', description: 'Reach level 20', icon: 'fa-crown', condition: (p) => p.level >= 20 },
                { id: '1000_xp', name: 'XP Collector', description: 'Accumulate 1000 XP', icon: 'fa-coins', condition: (p) => p.xp >= 1000 },
                { id: '5000_xp', name: 'XP Hoarder', description: 'Accumulate 5000 XP', icon: 'fa-gem', condition: (p) => p.xp >= 5000 },
                { id: 'daily_user', name: 'Dedicated', description: 'Use the app for 7 days', icon: 'fa-calendar', condition: (p) => p.stats.daysActive >= 7 },
                { id: 'quick_learner', name: 'Quick Learner', description: 'Gain 500 XP in one day', icon: 'fa-bolt', condition: (p) => p.stats.maxXpInDay >= 500 }
            ];
            
            // Initialize the application
            function init() {
                showScreen(mainMenu);
                renderMainMenuProfiles();
                setupEventListeners();
            }
            
            // Set up event listeners
            function setupEventListeners() {
                document.getElementById('createProfileBtn').addEventListener('click', function() {
                    showScreen(createProfileScreen);
                });
                
                document.getElementById('manageProfilesBtn').addEventListener('click', function() {
                    renderManageProfiles();
                    showScreen(manageProfilesScreen);
                });
                
                document.getElementById('createProfileConfirm').addEventListener('click', createProfile);
                
                document.getElementById('pinSubmit').addEventListener('click', verifyPin);
                
                document.getElementById('addXp').addEventListener('click', addXp);
                
                document.getElementById('resetXp').addEventListener('click', resetXp);
                
                document.getElementById('logoutBtn').addEventListener('click', logout);
                
                document.getElementById('exportData').addEventListener('click', exportData);
                
                document.getElementById('importData').addEventListener('click', () => importFile.click());
                
                importFile.addEventListener('change', importData);
                
                document.getElementById('changePin').addEventListener('click', changePin);
                
                document.getElementById('deleteProfile').addEventListener('click', deleteCurrentProfile);
                
                document.querySelectorAll('.backBtn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (this.parentElement.id === 'xpCounter') {
                            showScreen(loginScreen);
                        } else {
                            showScreen(mainMenu);
                        }
                    });
                });
                
                // Tab navigation
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        const tabName = this.getAttribute('data-tab');
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        this.classList.add('active');
                        document.getElementById(tabName).classList.add('active');
                        
                        if (tabName === 'stats') {
                            renderCharts();
                        } else if (tabName === 'achievements') {
                            renderAchievements();
                        } else if (tabName === 'history') {
                            renderXpHistory();
                        }
                    });
                });
                
                // Allow pressing Enter in input fields
                profilePinInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        createProfile();
                    }
                });
                
                pinInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        verifyPin();
                    }
                });
                
                xpInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addXp();
                    }
                });
            }
            
            // Show specific screen
            function showScreen(screen) {
                screens.forEach(s => s.classList.remove('active'));
                screen.classList.add('active');
            }
            
            // Render profiles on main menu
            function renderMainMenuProfiles() {
                mainMenuProfiles.innerHTML = '';
                if (profiles.length === 0) {
                    mainMenuProfiles.innerHTML = '<p>No profiles yet. Create your first profile!</p>';
                    return;
                }
                
                profiles.forEach(profile => {
                    const levelSystem = levelSystems[profile.levelSystem] || levelSystems.linear;
                    const level = levelSystem.calculateLevel(profile.xp);
                    
                    const profileElement = document.createElement('div');
                    profileElement.className = 'profile-item';
                    profileElement.innerHTML = `
                        <div class="profile-info">
                            <div class="profile-name">${profile.name}</div>
                            <div class="profile-xp">XP: ${profile.xp}</div>
                            <div class="profile-level">Level: ${level}</div>
                        </div>
                        <div class="profile-actions">
                            <button class="login-btn" data-id="${profile.id}">Login</button>
                        </div>
                    `;
                    mainMenuProfiles.appendChild(profileElement);
                });
                
                // Add event listeners to login buttons
                document.querySelectorAll('.login-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const profileId = this.getAttribute('data-id');
                        openLogin(profileId);
                    });
                });
            }
            
            // Render profiles for management
            function renderManageProfiles() {
                manageProfileList.innerHTML = '';
                if (profiles.length === 0) {
                    manageProfileList.innerHTML = '<p>No profiles to manage.</p>';
                    return;
                }
                
                profiles.forEach(profile => {
                    const levelSystem = levelSystems[profile.levelSystem] || levelSystems.linear;
                    const level = levelSystem.calculateLevel(profile.xp);
                    
                    const profileElement = document.createElement('div');
                    profileElement.className = 'profile-item';
                    profileElement.innerHTML = `
                        <div class="profile-info">
                            <div class="profile-name">${profile.name}</div>
                            <div class="profile-xp">XP: ${profile.xp}</div>
                            <div class="profile-level">Level: ${level}</div>
                        </div>
                        <div class="profile-actions">
                            <button class="delete-btn" data-id="${profile.id}">Delete</button>
                        </div>
                    `;
                    manageProfileList.appendChild(profileElement);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const profileId = this.getAttribute('data-id');
                        deleteProfile(profileId);
                    });
                });
            }
            
            // Render profiles for login
            function renderLoginProfiles() {
                profileList.innerHTML = '';
                if (profiles.length === 0) {
                    profileList.innerHTML = '<p>No profiles available.</p>';
                    return;
                }
                
                profiles.forEach(profile => {
                    const levelSystem = levelSystems[profile.levelSystem] || levelSystems.linear;
                    const level = levelSystem.calculateLevel(profile.xp);
                    
                    const profileElement = document.createElement('div');
                    profileElement.className = 'profile-item';
                    profileElement.innerHTML = `
                        <div class="profile-info">
                            <div class="profile-name">${profile.name}</div>
                            <div class="profile-xp">XP: ${profile.xp}</div>
                            <div class="profile-level">Level: ${level}</div>
                        </div>
                        <div class="profile-actions">
                            <button class="select-btn" data-id="${profile.id}">Select</button>
                        </div>
                    `;
                    profileList.appendChild(profileElement);
                });
                
                // Add event listeners to select buttons
                document.querySelectorAll('.select-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const profileId = this.getAttribute('data-id');
                        openPinEntry(profileId);
                    });
                });
            }
            
            // Create a new profile
            function createProfile() {
                const name = profileNameInput.value.trim();
                const pin = profilePinInput.value.trim();
                const levelSystem = levelSystemSelect.value;
                
                if (!name) {
                    showNotification('Please enter a profile name', 'error');
                    return;
                }
                
                if (!pin || pin.length !== 4 || isNaN(pin)) {
                    showNotification('PIN must be 4 digits', 'error');
                    return;
                }
                
                if (profiles.length >= 100) {
                    showNotification('Maximum number of profiles (100) reached', 'error');
                    return;
                }
                
                const newProfile = {
                    id: Date.now().toString(),
                    name: name,
                    pin: pin,
                    xp: 0,
                    levelSystem: levelSystem,
                    stats: {
                        totalXpGained: 0,
                        daysActive: 1,
                        lastActive: new Date().toISOString(),
                        maxXpInDay: 0,
                        xpByCategory: {
                            general: 0,
                            quests: 0,
                            skills: 0,
                            achievements: 0
                        }
                    },
                    achievements: [],
                    history: []
                };
                
                profiles.push(newProfile);
                saveProfiles();
                
                profileNameInput.value = '';
                profilePinInput.value = '';
                
                showNotification('Profile created successfully!');
                showScreen(mainMenu);
                renderMainMenuProfiles();
            }
            
            // Delete a profile
            function deleteProfile(profileId) {
                if (confirm('Are you sure you want to delete this profile?')) {
                    profiles = profiles.filter(profile => profile.id !== profileId);
                    saveProfiles();
                    renderManageProfiles();
                    renderMainMenuProfiles();
                    showNotification('Profile deleted');
                }
            }
            
            // Delete current profile
            function deleteCurrentProfile() {
                if (confirm('Are you sure you want to delete your profile? This action cannot be undone.')) {
                    profiles = profiles.filter(profile => profile.id !== currentProfile.id);
                    saveProfiles();
                    showNotification('Profile deleted');
                    logout();
                }
            }
            
            // Open login for a specific profile
            function openLogin(profileId) {
                currentProfile = profiles.find(profile => profile.id === profileId);
                if (currentProfile) {
                    showScreen(pinEntryScreen);
                }
            }
            
            // Open PIN entry for a profile
            function openPinEntry(profileId) {
                currentProfile = profiles.find(profile => profile.id === profileId);
                if (currentProfile) {
                    showScreen(pinEntryScreen);
                }
            }
            
            // Verify PIN and login
            function verifyPin() {
                const enteredPin = pinInput.value.trim();
                
                if (enteredPin === currentProfile.pin) {
                    // Update activity stats
                    const today = new Date().toISOString().split('T')[0];
                    const lastActive = new Date(currentProfile.stats.lastActive).toISOString().split('T')[0];
                    
                    if (today !== lastActive) {
                        currentProfile.stats.daysActive++;
                        currentProfile.stats.lastActive = new Date().toISOString();
                        currentProfile.stats.xpToday = 0;
                    }
                    
                    pinInput.value = '';
                    currentProfileName.textContent = currentProfile.name;
                    updateXpDisplay();
                    showScreen(xpCounterScreen);
                    saveProfiles();
                } else {
                    showNotification('Incorrect PIN', 'error');
                }
            }
            
            // Add XP to current profile
            function addXp() {
                const xpToAdd = parseInt(xpInput.value);
                const category = document.getElementById('xpCategory').value;
                
                if (isNaN(xpToAdd) || xpToAdd <= 0) {
                    showNotification('Please enter a valid XP amount', 'error');
                    return;
                }
                
                // Show loading animation
                xpAmount.innerHTML = '<div class="loader"></div>';
                
                // Simulate loading process
                setTimeout(() => {
                    currentProfile.xp += xpToAdd;
                    currentProfile.stats.totalXpGained += xpToAdd;
                    currentProfile.stats.xpByCategory[category] += xpToAdd;
                    
                    // Update today's XP
                    const today = new Date().toISOString().split('T')[0];
                    if (!currentProfile.stats.xpToday) {
                        currentProfile.stats.xpToday = 0;
                    }
                    currentProfile.stats.xpToday += xpToAdd;
                    
                    if (currentProfile.stats.xpToday > currentProfile.stats.maxXpInDay) {
                        currentProfile.stats.maxXpInDay = currentProfile.stats.xpToday;
                    }
                    
                    // Add to history
                    currentProfile.history.unshift({
                        date: new Date().toISOString(),
                        amount: xpToAdd,
                        category: category
                    });
                    
                    // Keep only last 100 history items
                    if (currentProfile.history.length > 100) {
                        currentProfile.history = currentProfile.history.slice(0, 100);
                    }
                    
                    xpInput.value = '';
                    
                    updateXpDisplay();
                    checkAchievements();
                    saveProfiles();
                    
                    showNotification(`Added ${xpToAdd} XP!`);
                }, 1000);
            }
            
            // Update XP display with level information
            function updateXpDisplay() {
                const levelSystem = levelSystems[currentProfile.levelSystem] || levelSystems.linear;
                const level = levelSystem.calculateLevel(currentProfile.xp);
                const xpForNextLevel = levelSystem.xpForNextLevel(currentProfile.xp, level);
                const xpInCurrentLevel = currentProfile.xp - levelSystem.xpForLevel(level);
                const progress = Math.min(100, Math.floor((xpInCurrentLevel / xpForNextLevel) * 100));
                
                xpAmount.textContent = currentProfile.xp;
                levelAmount.textContent = level;
                nextLevelXp.textContent = xpForNextLevel;
                levelProgress.style.width = `${progress}%`;
                levelProgress.textContent = `${progress}%`;
                
                // Update stats
                totalXpGained.textContent = currentProfile.stats.totalXpGained;
                daysActive.textContent = currentProfile.stats.daysActive;
                avgXpPerDay.textContent = Math.floor(currentProfile.stats.totalXpGained / currentProfile.stats.daysActive);
                achievementsEarned.textContent = `${currentProfile.achievements.length} / ${achievements.length}`;
            }
            
            // Check for new achievements
            function checkAchievements() {
                achievements.forEach(achievement => {
                    if (!currentProfile.achievements.includes(achievement.id) && 
                        achievement.condition(currentProfile)) {
                        currentProfile.achievements.push(achievement.id);
                        showNotification(`Achievement unlocked: ${achievement.name}!`, 'success');
                    }
                });
            }
            
            // Render achievements
            function renderAchievements() {
                achievementsGrid.innerHTML = '';
                
                achievements.forEach(achievement => {
                    const isUnlocked = currentProfile.achievements.includes(achievement.id);
                    
                    const achievementElement = document.createElement('div');
                    achievementElement.className = `achievement ${isUnlocked ? '' : 'locked'}`;
                    achievementElement.innerHTML = `
                        <i class="fas ${achievement.icon}"></i>
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-desc">${achievement.description}</div>
                        <div class="achievement-status">${isUnlocked ? 'Unlocked' : 'Locked'}</div>
                    `;
                    achievementsGrid.appendChild(achievementElement);
                });
            }
            
            // Render XP history
            function renderXpHistory() {
                xpHistoryList.innerHTML = '';
                
                if (currentProfile.history.length === 0) {
                    xpHistoryList.innerHTML = '<p>No XP history yet.</p>';
                    return;
                }
                
                currentProfile.history.forEach(entry => {
                    const date = new Date(entry.date);
                    const dateStr = date.toLocaleDateString();
                    const timeStr = date.toLocaleTimeString();
                    
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div>
                            <div>${dateStr} ${timeStr}</div>
                            <div class="history-category">${entry.category}</div>
                        </div>
                        <div class="history-xp">+${entry.amount} XP</div>
                    `;
                    xpHistoryList.appendChild(historyItem);
                });
            }
            
            // Render charts
            function renderCharts() {
                // Destroy existing charts if they exist
                if (xpDistributionChart) {
                    xpDistributionChart.destroy();
                }
                if (xpHistoryChart) {
                    xpHistoryChart.destroy();
                }
                
                // XP Distribution Chart
                const distributionCtx = document.getElementById('xpDistributionChart').getContext('2d');
                xpDistributionChart = new Chart(distributionCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(currentProfile.stats.xpByCategory),
                        datasets: [{
                            data: Object.values(currentProfile.stats.xpByCategory),
                            backgroundColor: [
                                '#4776E6',
                                '#8E54E9',
                                '#FF512F',
                                '#DD2476'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'XP by Category'
                            }
                        }
                    }
                });
                
                // XP History Chart (last 7 days)
                const historyCtx = document.getElementById('xpHistoryChart').getContext('2d');
                
                // Group history by day for the last 7 days
                const last7Days = [];
                const today = new Date();
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(today.getDate() - i);
                    last7Days.push(date.toISOString().split('T')[0]);
                }
                
                const xpByDay = last7Days.map(day => {
                    return currentProfile.history
                        .filter(entry => entry.date.split('T')[0] === day)
                        .reduce((sum, entry) => sum + entry.amount, 0);
                });
                
                xpHistoryChart = new Chart(historyCtx, {
                    type: 'bar',
                    data: {
                        labels: last7Days.map(day => {
                            const date = new Date(day);
                            return date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
                        }),
                        datasets: [{
                            label: 'XP Gained',
                            data: xpByDay,
                            backgroundColor: '#4776E6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'XP Gained (Last 7 Days)'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // Reset XP for current profile
            function resetXp() {
                if (confirm('Are you sure you want to reset your XP to zero?')) {
                    currentProfile.xp = 0;
                    currentProfile.stats.totalXpGained = 0;
                    currentProfile.stats.xpByCategory = {
                        general: 0,
                        quests: 0,
                        skills: 0,
                        achievements: 0
                    };
                    currentProfile.history = [];
                    currentProfile.achievements = currentProfile.achievements.filter(a => a === 'first_xp');
                    updateXpDisplay();
                    saveProfiles();
                    showNotification('XP reset to zero');
                }
            }
            
            // Change PIN
            function changePin() {
                const newPin = prompt('Enter a new 4-digit PIN:');
                
                if (!newPin || newPin.length !== 4 || isNaN(newPin)) {
                    showNotification('PIN must be 4 digits', 'error');
                    return;
                }
                
                if (confirm('Are you sure you want to change your PIN?')) {
                    currentProfile.pin = newPin;
                    saveProfiles();
                    showNotification('PIN changed successfully');
                }
            }
            
            // Export data
            function exportData() {
                const dataStr = JSON.stringify(currentProfile, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `${currentProfile.name}_xp_data.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Data exported successfully');
            }
            
            // Import data
            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (confirm('Are you sure you want to import this data? Your current data will be overwritten.')) {
                            // Preserve ID and name
                            const id = currentProfile.id;
                            const name = currentProfile.name;
                            const pin = currentProfile.pin;
                            
                            Object.assign(currentProfile, importedData);
                            
                            // Restore ID and name
                            currentProfile.id = id;
                            currentProfile.name = name;
                            currentProfile.pin = pin;
                            
                            updateXpDisplay();
                            saveProfiles();
                            showNotification('Data imported successfully');
                        }
                    } catch (error) {
                        showNotification('Error importing data: Invalid file format', 'error');
                    }
                };
                reader.readAsText(file);
                
                // Reset file input
                event.target.value = '';
            }
            
            // Save profiles to localStorage
            function saveProfiles() {
                localStorage.setItem('xpProfiles', JSON.stringify(profiles));
            }
            
            // Show notification
            function showNotification(message, type = 'success') {
                notification.textContent = message;
                notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            // Logout function
            function logout() {
                currentProfile = null;
                showScreen(mainMenu);
            }
            
            // Initialize the app
            init();
        });
    </script>
</body>
</html>
